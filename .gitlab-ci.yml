image: registry.gitlab.com/docker.hub/teracy/angular-cli

stages:
    - install
    # - test
    - build
    - deploy

.libs-cache:
    tags:
        - docker
    cache:
        paths:
            - node_modules/

install:
    stage: install
    extends: .libs-cache
    script:
        - npm i

# lint:
#     extends: .libs-cache
#     stage: test
#     cache:
#         policy: pull
#     script:
#         - npm run lint

# test:
#     image: trion/ng-cli-karma
#     allow_failure: true
#     extends: .libs-cache
#     stage: test
#     cache:
#         policy: pull
#     script:
#         - npm run test:prod

# e2e:
#     image: trion/ng-cli-karma
#     extends: .libs-cache
#     stage: test
#     cache:
#         policy: pull
#     script:
#         - npm run e2e

build-web-ssr:
    stage: build
    tags:
        - docker
    cache:
        paths:
            - dist/
            - node_modules/
    artifacts:
        expire_in: 1 day
        paths:
            - dist/
    script:
        # - npm run build:ssr
        - npm install --save-dev @angular-devkit/build-angular
        - npm run build:static
    # after_script:
    #     - npm run test:ssr
# .deploy:
#     image: docker:latest
#     stage: deploy
#     services:
#         - docker:dind
#     cache:
#         policy: pull
#         paths:
#             - dist/
#     before_script:
#         - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
#     tags:
#         - docker
#     script:
#         - docker build -t "$IMAGE" --force-rm --no-cache -f Dockerfile.ssr .
#         - docker push $IMAGE
#     after_script:
#         - docker logout

# deploy-develop:
#     variables:
#         IMAGE: $CI_REGISTRY_IMAGE:develop
#     extends: .deploy
#     only:
#         - develop
#         - master

deploy:
    stage: deploy
    services:
        - registry.gitlab.com/docker.hub/docker:dind
    image: registry.gitlab.com/docker.hub/docker:latest
    cache:
        paths:
            - dist/
    only:
        - develop
        - charts
        - ci
    script:
        - CONTAINER_IMAGE="$CI_REGISTRY/$CI_PROJECT_PATH"
        - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
        - docker build --tag $CONTAINER_IMAGE:latest .
        - docker push $CONTAINER_IMAGE:latest
        - docker logout
    tags:
        - docker
